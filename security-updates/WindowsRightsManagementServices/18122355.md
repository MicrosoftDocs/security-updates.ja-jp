---
TOCTitle: ログ データベースの保守
Title: ログ データベースの保守
ms:assetid: 'de55058b-0d1a-4997-8a45-e14678ddd13f'
ms:contentKeyID: 18122355
ms:mtpsurl: 'https://technet.microsoft.com/ja-jp/library/Cc747691(v=WS.10)'
---

ログ データベースの保守
=======================

ログ エントリには、ユーザー登録や使用ライセンスの割り当てなど、RMS のさまざまな操作用に発行されるライセンスのコピーも含まれています。すべてのログ エントリにユーザー登録の成功、または使用ライセンスの取得成功が記録される最悪のシナリオでは、各ログ エントリにつき、ログ データベースのサイズが 約 200 KB 増加します。

例として、50,000 人の従業員 (ユーザー) を抱える企業で、全従業員に RMS で保護された電子メール メッセージが送信され、各人がそれを開封する場合を考えてみます。各従業員がこの電子メール メッセージを 1 日以内に開封した場合、ログ データベースのサイズは 10 GB 増加します。実際の XrML データを記録しないようにリスナ サービスを設定して、記録される情報量を減らすことができます。

古い情報をログ データベースからセカンダリ データベースにアーカイブするスクリプトを作成することを検討してください。ログ スクリプトの例は RMS ツールキットに含まれています。このツールキットは、[マイクロソフトの Web サイト](http://go.microsoft.com/fwlink/?linkid=26724) (http://go.microsoft.com/fwlink/?LinkId=26724) から無料でダウンロードできます。

ログ データベースのサイズを増加させる要因
-----------------------------------------

ログ データベースのサイズ予測は、環境によって異なります。ただし、ログに含まれる次のような "スタートアップ" エントリは予測可能です。

-   RMS サーバーの登録
-   ユーザーの登録 (各ユーザーが使用するコンピュータごとに固有の要求)
-   オフライン発行証明書の自動ユーザー要求

最初のスタートアップ エントリ後にログ データベースに追加されるエントリの大半は、保護されたコンテンツの使用ライセンスの発行に関するものです。データベース サイズは、次のようないくつかの条件によって増加します。

-   ユーザーが保護されたコンテンツにアクセスするたびに、新しいライセンスが必要。これは、オプションの設定であり、保護されたドキュメントにアクセスする既定の方法ではありません。この方法を使用すると、データベース サイズは急速に増加します。
-   各ユーザーに 1 日に送信される保護された電子メール メッセージ数。
-   これらの保護された電子メール メッセージを読むユーザー数。
-   各ユーザーが 1 日に作成する Microsoft Office 2003 (Word、PowerPoint、および Excel) ドキュメント数。
-   保護されたドキュメントの利用者数。

ログ データベースの初期サイズは約 1.7 MB です。この中には、RMS サーバーによる証明書の要求が含まれます。新しく登録したユーザーは、RM アカウント証明書 (RAC) とクライアント ライセンサ証明書 (CLC) を取得します。この 2 つの処理はログに記録され、その過程でデータベース サイズは 0.06 MB 増加します。また、各ユーザーが保護されたコンテンツのライセンスを取得するたびに、データベース サイズは 0.19 MB 増加します。

この予測をもとに、5,000 人のユーザーを抱える組織で RMS を展開する場合について検討してみます。各ユーザーは 1 台のコンピュータを持ち、組織で使用する RMS サーバーは 2 台です。展開後、各ユーザーは RMS で保護された電子メール メッセージを平均で 1 日に 1 通作成し、それを 5 人のユーザーに送信します。また、各ユーザーは RMS で保護されたドキュメントを 1 日に 1 部作成し、そのドキュメントに本人以外に 3 人のユーザーがアクセスします。次の表に、この条件でログ データベースのサイズがどの程度増加するのかを示します。

###  

 
<table style="border:1px solid black;">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>処理</th>
<th>ログの増加量</th>
<th>累積ログ サイズ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">RMS サーバーが正常に提供される</td>
<td style="border:1px solid black;">1.7 MB</td>
<td style="border:1px solid black;">1.7 MB</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">5,000 人の従業員が登録する (5,000*0.06)</td>
<td style="border:1px solid black;">300 MB</td>
<td style="border:1px solid black;">301.7 MB</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">保護された電子メール メッセージにアクセスする (25,000*0.19)</td>
<td style="border:1px solid black;">4,750 MB</td>
<td style="border:1px solid black;">5,051.7 MB</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">保護されたドキュメントにアクセスする (15,000*0.19)</td>
<td style="border:1px solid black;">2,850 MB</td>
<td style="border:1px solid black;">7,901.7 MB</td>
</tr>
</tbody>
</table>
  
つまり、登録後のログ データベースの静的サイズは約 300 MB です。ただし、この例では、メッセージ キュー インストールの既定の限界値である 8 GB に近い 7.6 GB が 1 日に追加されます。ログ データベースが 1 日以上使用できなくなると、ログ エントリは失われ始めます。
  
ログ データベース サイズの制御  
------------------------------
  
展開計画には、ログ データベースの管理方法を含める必要があります。次に最も一般的な方法を示します。
  
-   **排除とアーカイブ**  
    この方法では、SQL Server スクリプトを使用して、一定期間経過したログ エントリの中の一部の情報を、ログ データベースからセカンダリ データベースにアーカイブします。また、データベースをフィルタ処理して無関係な情報を排除し、領域の無駄を省きます。  
-   **記録される情報の制限**  
    ログ データベースは 3 つの主要なテーブルで構成されています。1 つは **DRMS\_Log\_Filter** です。このテーブルでは、ログのフィルタ処理を有効にした場合に記録される、マスタ テーブル内のフィールドを識別します。  
    オン/オフのテーブル エントリによって、RMS サーバーのログ リスナ サービスで実際に記録する、マスタ テーブル内のフィールドを指定します。XrML に関連する 2 つのフィールドは、各ライセンス要求行の約 99% のサイズを占めているので、あらかじめ 0 に設定され、ログが無効化されています。  
    **DRMS\_Config\_ServerName\_Port** データベースには、**DRMS\_ClusterPolicies** というテーブルもあります。このテーブルには、**LoggingFiltering** の **PolicyName** が含まれています。**LoggingFiltering** は既定で無効になっています。**LoggingFiltering** の値を 1 に変更してログ リスナ サービスを再開すると、上の例で示した 1 日のデータベース サイズ増加量が 7.6 GB から約 160 MB まで減少します。  
-   **ログ データベースの移動**  
    ログ データベース サイズの増加を管理するもう 1 つのオプションは、単純に、より大きなディスク領域を持つサーバーにデータベースを移動することです。ログ データベースは、構成データベースと異なるデータベース サーバーに配置できます。データベースを別のサーバーに移動するには、次の手順に従います。  
    1.  各 RMS サーバーのログ リスナ サービスを停止します。  
    2.  別のサーバーにデータベースをコピーするか、新しいデータベースを作成します。  
    3.  **DRMS\_ClusterPolicies** を選択して **LoggingDatabaseName** (データベース サーバー名) と **LoggingDatabaseServer** (データベース名) の値を編集し、RMS の **DRMS\_Config\_ServerName\_Port** データベースを編集します。  
    4.  コマンド ラインから IISRESET.exe を実行して、IIS を再起動します。
