---
TOCTitle: 'Data Encryption Toolkit for Mobile PCs : 第 3 章 : 暗号化ファイル システム'
Title: 'Data Encryption Toolkit for Mobile PCs : 第 3 章 : 暗号化ファイル システム'
ms:assetid: 'dc2cde72-a84d-4716-9a30-f62b608efda1'
ms:contentKeyID: 19869270
ms:mtpsurl: 'https://technet.microsoft.com/ja-jp/library/Cc162818(v=TechNet.10)'
---

Data Encryption Toolkit for Mobile PCs – セキュリティ分析
=========================================================

### 第 3 章 : 暗号化ファイル システム

公開日: 2007年8月20日

**ダウンロード**
[Data Encryption Toolkit for Mobile PCs を入手する (英語)](http://www.microsoft.com/downloads/details.aspx?familyid=1a99576a-fe67-418f-88b1-81e2055fe977&displaylang=en)

Microsoft® Windows® XP と Windows Vista™ には、暗号化ファイル システム (EFS) によるデータ保護機能と保護されたデータの回復機能があります。 EFS は個々のファイルまたは特定フォルダ内の全ファイルに適用できるデータ暗号化テクノロジです。 対応するキー マテリアルがないと、EFS ファイルの暗号化は解除できません。 また、重要な点として、Microsoft BitLocker™ ドライブ暗号化 (BitLocker) と異なり、EFS はオペレーティング システムの起動に必要なファイルには適用できません。

BitLocker ではシステム ボリューム全体で全データの暗号化を保証しますが、EFS では 1 台のコンピュータで 1 人または複数のユーザーの暗号化を構成する場合により精度が高く、柔軟性が高いことが利点となっています。 たとえば、EFS を使用すると、多くの異なるユーザーがアクセスするネットワーク内のデータ ファイルを暗号化できます。これは、BitLocker の機能ではできません。

EFS では、ユーザーと承認された回復エージェントのみがアクセスできるキーでファイルを保護することで、ユーザー単位の暗号化が可能です。 ファイルのコピーを入手した攻撃者は、さらにキー マテリアルも入手するか、またはファイルを暗号化したユーザーとしてログオンして、元の場所から別の場所に直接的にファイルをコピーしない限り、これらのファイルを参照することはできません。

##### トピック

[](#egaa)[Windows XP での EFS](#egaa)  
[](#efaa)[Windows Vista での EFS](#efaa)  
[](#eeaa)[EFS オプション : ソフトウェア キー ストレージを使用する EFS](#eeaa)  
[](#edaa)[EFS オプション : スマート カードを使用する EFS](#edaa)  
[](#ecaa)[EFS リスク分析の要約](#ecaa)  
[](#ebaa)[関連情報](#ebaa)

### Windows XP での EFS

EFS は Windows 2000 にもありますが、Windows XP と Windows Server® 2003 の EFS には、次のような重要な機能が追加されています。

-   強化された回復機能。

-   暗号化ファイル共有時に使用する証明書の失効チェックの完全サポート。

-   保護ファイルの簡単な検索と確認を目的としてエクスプローラに加えられたユーザー インターフェイスの変更。

-   Windows XP による暗号化されたオフライン フォルダのサポート。

-   暗号化ファイルの複数ユーザー サポート。

-   Microsoft Enhanced and Strong 暗号化サービス プロバイダ (CSP) のサポート。

-   WebDAV で EFS を使用したエンドツーエンドの暗号化。

Windows XP の EFS 拡張機能の詳細については、記事「[Encrypting File System in Windows XP and Windows Server 2003](http://technet.microsoft.com/library/bb457065.aspx)」(英語) を参照してください。

この章で説明するすべての EFS シナリオでは、ログオン ユーザーは、エクスプローラの **\[属性の詳細\]**

![](images/Cc162818.c43d3fd1-4a4f-4ad0-8462-5a6eab0bfbb4(ja-jp,TechNet.10).gif)

**図 3.1 Windows XP の \[属性の詳細\] ダイアログ ボックス**

フォルダでファイルを初めて暗号化するとき、選択したファイルを暗号化するのか、フォルダ全体を暗号化するのか質問するプロンプトが表示されます。

EFS 暗号化ポリシーの適用範囲を詳細に管理する必要がある組織の場合、グループ ポリシー オブジェクト (GPO) を使用して EFS を集中的に管理し、組織全体にわたって暗号化を構成するために、Cipher.exe ユーティリティを使用するスクリプトを自動的に配布することもできます。

![](images/Cc162818.note(ja-jp,TechNet.10).gif)**注 :**

ソフトウェア ベースの場合も、スマート カード ベースの場合も、EFS では、すべての操作に対して、関連付けられた証明書が必要になります。 たとえば、スマート カード ベースの EFS では、暗号化または暗号化の解除を実行するたびにカードが必要とされます。 この機能では、関連する秘密キーがない証明書で間違ってファイルが暗号化されることが防止されます。これは、秘密キーがない場合、その証明書を暗号化に使用できないためです。

[](#mainsection)[ページのトップへ](#mainsection)

### Windows Vista での EFS

EFS は現在 Windows Vista Business、Enterprise、および Ultimate エディションで利用することができ、Windows Server "Longhorn" リリースでも利用可能になる予定です。 Windows Vista は、次のような追加の重要な拡張機能を EFS に提供しています。

-   EFS 暗号化のためにスマート カードに直接的に保存される暗号化キーの利用。

-   EFS で使用される証明書のウィザードによる作成/選択。

-   古いスマート カードから新しいスマート カードへのウィザードによるファイルの移行。

-   EFS を有効にした場合のシステム ページング ファイルの暗号化。

-   管理者が EFS に対して組織のポリシーを定義、実装するときに役立つ新しいグループ ポリシー オプション。 これらのオプションには、たとえば、EFS でスマート カードを必須とする機能、ページ ファイルの暗号化を強制する機能、EFS の最小のキー長を定める機能、ユーザーのマイ ドキュメント フォルダの暗号化を強制する機能などがあります。

-   Windows Vista で EFS 機能を詳細に管理するための拡張機能は、次のように、新しいユーザー インターフェイスに表示されます。

![](images/Cc162818.44c4c3c8-7669-4318-8847-1d5a56121c14(ja-jp,TechNet.10).gif)

**図 3.2 Windows Vista の EFS 管理インターフェイス**

この章の以降の項では、2 つの EFS オプションを説明し、それぞれのオプションで提供する保護レベルを説明します。

[](#mainsection)[ページのトップへ](#mainsection)

### EFS オプション : ソフトウェア キー ストレージを使用する EFS

この EFS オプションで必要とされるのは、Windows XP または Windows Vista ベースのコンピュータのみです。

次の図は、このオプションによる EFS の暗号化プロセスを論理的に示しています。

![](images/Cc162818.67dc08b1-9271-4491-b617-43ccb0020ebc(ja-jp,TechNet.10).gif)

**図 3.3 EFS の暗号化プロセス**

図示した暗号化プロセスの各ステップは、次のとおりです。

1.  ユーザーが暗号化フォルダで新規ファイルを作成します。

2.  対称ファイル暗号化キー (FEK) がランダムに生成されます。

3.  オペレーティング システムにより、ユーザーの証明書ストアで、適切なキー利用フラグが設定された証明書がないかチェックされます。 適切な証明書がない場合は、証明書が自動的に生成されます。

4.  データ保護 API (DPAPI) を使用して、ユーザーの証明書に関連付けられた秘密キーが暗号化され、保存されます。

5.  証明書の公開キーを使用して FEK が暗号化され、ファイル メタデータに格納されます。

6.  FEK を使用して、データの各ブロックが暗号化されます。

7.  暗号化されたブロックがディスクに書き込まれます。

次の図は、このオプションによる EFS の暗号化解除のプロセスを論理的に示しています。

![](images/Cc162818.8e90f3ca-64ed-456e-be71-29bf3388699b(ja-jp,TechNet.10).gif)

**図 3.4 EFS の暗号化解除プロセス**

図示した暗号化解除プロセスの各ステップは、次のようになります。

1.  ユーザーのログオンが、ローカルで検証されるか、ドメイン コントローラによって検証されます。

2.  ユーザーが暗号化されたファイルへのアクセスを試行します。

3.  DPAPI を使用してユーザーの X.509 証明書と関連付けられた秘密キーが抽出され、ユーザーのログオン資格情報から生成されたキーを使用してこの秘密キーの暗号化が解除されます。

4.  FEK がファイルから抽出され、前のステップで取得した秘密キーで暗号化が解除されます。

5.  必要に応じて、FEK を使用してファイルの各ブロックの暗号化が解除されます。

6.  暗号化を解除されたデータが、処理を要求したアプリケーションに渡されます。

EFS の追加情報については、「[暗号化ファイルシステム](http://technet.microsoft.com/ja-jp/library/cc162816.aspx)」を参照してください。

#### 軽減されるリスク : ソフトウェア キー ストレージを使用する EFS

この EFS オプションでは、データに対する次のリスクが軽減されます。

-   **部内者による暗号化ファイルの閲覧**。 BitLocker と比べた場合の EFS の利点は、暗号化キーがユーザーの資格情報で保護された安全なキー ストアに保存されることです。 この構成では、資格情報はパスワードです。 したがって、コンピュータで認証されたその他のユーザーは、対話的な手順を通じて、またはネットワークを通じてコンピュータにログオンできますが、ファイルへのアクセス許可が特別に与えられている場合を除いて、別のユーザーによって EFS で保護された機密ファイルにはコンピュータ上でアクセスすることができません。

-   **オフライン攻撃によるキーの検出**。 攻撃者がユーザーのパスワードではなく、FEK または DPAPI マスタ キーなどのキーを標的にすると仮定した場合、EFS 回復キー (EFS が使用する証明書の秘密キー) または DPAPI マスタ キーがブルート フォース攻撃にさらされる危険があります。 多くの組織にとって、この脅威は大きな懸念事項にはなりません。EFS が使用する強力なキーに対して、この種類の攻撃が成功することは困難であるためです。

-   **システム ページング ファイルからのプレーンテキスト データの漏洩 (Windows Vista** **のみ)**。 Windows Vista には、システム ページング ファイルの内容を暗号化する機能があり、データ漏洩の 1 つの原因がこれで解決されています。 この機能は、コンピュータでの使用中に、DPAPI マスタ キー (次のトピックを参照) など、Windows Vista EFS キーを保護するために特別に実装されました。 またこの機能では、アプリケーションでの使用中に、ページ ファイル内のプレーンテキスト データが参照できるという EFS オプションのリスクにも対応できます。 ページ ファイルの暗号化に使用される暗号化キーは一時的な値であり、Local Security Authority (LSA) 内で生成されます。 これらはユーザーのログオン資格情報または X.509 証明書からは生成されません。 コンピュータのシャットダウン (またはクラッシュ) 後は、暗号化されたページ ファイル データを回復できません。また、ブルート フォース攻撃以外の既知の方法では、このデータを読み取ることができません。

#### その他のリスクとその軽減 : ソフトウェア キー ストレージを使用する EFS

次のリスクは、コントロールやポリシーを追加しないと、この EFS オプションでは軽減できません。

-   **休止状態のコンピュータ**。 BitLocker オプションと同様に、スリープまたは休止状態モードからの再開時にパスワード入力を要求するようにコンピュータが構成されていない場合、オペレーティング システムでは、現在のユーザーが適切なユーザーかどうかを判別することができません。 このような状況では、攻撃者が認証されたユーザーになりすましてラップトップを利用できます。 この攻撃者により、重要なデータがリムーバブル デバイスまたはネットワークの特定の場所にコピーされてしまう危険があります。 ただし、スリープまたは休止状態モードからの再開時にユーザーの資格情報を要求するようにコンピュータが構成されている場合、このリスクは軽減されます。

-   **スリープ (スタンバイ) モードのコンピュータ**。 前述のリスクの軽減方法の説明と同じです。

-   **ログオンしたままのコンピュータ、ロックされていないデスクトップ**。 ユーザーがコンピュータにログオンした後、資格情報は EFS 用に使用する証明書の暗号化を解除するために利用できます。 暗号化を解除した後は、キーボードを使用できるすべてのユーザーが、暗号化が解除されたデータにアクセスできます。 このリスクを軽減する最も優れた方法は、コンピュータ上に機密情報を持っているユーザーを対象としたセキュリティ意識向上トレーニングです。

-   **ローカル/ドメイン パスワードの検知**。 この構成では、EFS キーは、まずユーザーのパスワードから生成されたキーから暗号化が解除されます。 したがって、ユーザーのパスワードが侵害されると、EFS の暗号化も侵害されます。 辞書攻撃などの攻撃を防止する強固なパスワード ポリシーを実装したり、パスワード保護の重要性についてユーザーを教育したりすることで、このリスクを軽減することができます。

-   **オペレーティング システムへのオフライン攻撃**。 EFS には、オフライン攻撃に対して、コンピュータ上のオペレーティング システムを保護する機能や、オペレーティング システム構成ファイルを保護する機能がありません。

-   **オペレーティング システムへのオンライン攻撃**。 オペレーティング システムに対するオンライン攻撃はこのオプションで緩和されません。 オペレーティング システム上で選択したコードを入手した攻撃者に、暗号化キーが盗まれる可能性があります。

-   **休止状態ファイルからのプレーンテキスト データの漏えい**。 EFS には、システムの休止状態ファイルを保護する機能がありません。 このリスクは、Windows Vista にアップグレードして BitLocker を使用するか、休止状態を無効にすることで軽減できます。

    ![](images/Cc162818.important(ja-jp,TechNet.10).gif)**重要 :**

    休止状態を無効にすると、モバイル PC の利便性が低下します。 極めて重要な情報資産を保存するコンピュータでは、この方法が適している場合もありますが、通常はもっとふさわしい方法が別にあります。

-   **システム ページング ファイルからのプレーンテキスト データの漏えい (Windows XP** **のみ)**。 Windows XP の場合、システム ページング ファイルなどのシステム ファイルを EFS を使用して暗号化することができません。 この制限は、機密データがアプリケーションからアクセスされる場合、メモリ ページング操作の通常の動作として、データがディスクに書き込まれる可能性があることを意味します。 このリスクは、Windows Vista にアップグレードするか、メモリ ページングを使用しないようにコンピュータを構成することで軽減できます。

    ![](images/Cc162818.important(ja-jp,TechNet.10).gif)**重要 :**

    メモリ ページングを無効にすると、通常、コンピュータのパフォーマンスに影響が出ますが、場合によっては大幅に低下することもあります。

-   **プラットフォームへの攻撃**。 ソフトウェア キー ストレージで EFS を使用するように構成されたコンピュータは、ディスクとメモリに EFS キーを保持します。 直接メモリ アクセスまたはその他のハードウェア操作テクニックを使用するプラットフォームへの攻撃では、キー マテリアルを回復できる危険があります。

-   **コンピュータに残された認証要素**。 このオプションでは、別の認証要素は存在しません。 唯一の認証要素はユーザーのコンピュータまたはネットワークのパスワードです。

-   **ユーザー エラー**。 ユーザーは EFS が有効になっていない場所に、機密データを含むファイルを保存しないように注意する必要があります。 Windows Vista の場合、ユーザーのドキュメント フォルダにあるファイルをすべて暗号化できる EFS 構成オプションがあるため、このリスクは部分的に軽減されています。 この機能により、適切なファイルとディレクトリの暗号化を確実に行うことが容易になります。 また Microsoft 暗号化ファイル システム アシスタント ツール (EFS アシスタントはこのソリューション アクセラレータの一部として提供されます) を使用して、EFS によるユーザー ファイル保護のプロセスを自動化することで、このリスクを軽減することもできます。

[](#mainsection)[ページのトップへ](#mainsection)

### EFS オプション : スマート カードを使用する EFS

EFS のセキュリティ特性を改善するために、さまざまなバージョンの Windows でさまざまな機能が提供されています。 これらの機能の詳細については、以降の項で説明します。

#### Windows XP とスマート カード ログオン

**\[ネットワークに接続するにはスマート カードが必要です\]** は、Active Directory® ディレクトリ サービスで構成するドメイン ユーザー設定です。この設定が有効の場合、ユーザーはスマート カードを使用してドメイン アカウントにログオンする必要があります。 EFS の主要なリスクは、ユーザーのパスワードが侵害された場合、攻撃者はそのアカウントを使用してコンピュータにログオンし、EFS によって保護されたデータを含めて、コンピュータ上のデータにアクセスできる可能性があることです。

ログオンのためにスマート カードを要求する Active Directory ポリシー設定では、アカウントのセキュリティが大幅に改善され、同時に EFS によって保護されているデータのセキュリティも改善されます。 また、DPAPI 暗号化のために EFS で使用されるキーが強化されるため、この設定はオフライン攻撃から暗号化データを保護する場合にも役立ちます。 DPAPI は、ユーザー資格情報からキーを生成することで機能します。

スマート カード ログオンは、ユーザー単位とコンピュータ単位の 2 つの異なる単位で要求できます。 これは各モードで有効にしたり、強制したりすることができます。 これらのモードには、次のような重要なセキュリティ上の相違点があります。

-   ユーザー単位でスマート カード ログオンを強制する場合、最初のキーは一般的なパスワードよりも大幅に強度が高くなります。 攻撃者は、パスワードに対して辞書攻撃を実行できず、秘密キーに対して、ブルート フォース攻撃をしかける必要があります。しかし、この秘密キーは、現在のテクノロジでは事実上侵害できないほど長い値に設定できます。

-   コンピュータ単位のスマート カード ログオンを強制すると、第 2 の認証要素が追加されるため、パスワードのみのログオンに比べて、いくつかの点でセキュリティが向上します。 ただし、コンピュータ単位のスマート カード ログオンでは、ログオン認証に対してのみスマート カードが使用されます。 暗号化された DPAPI マスタ キーを取得できる攻撃者は、ユーザー単位のスマート カード ログオンで保護された DPAPI マスタ キーにブルート フォース攻撃をしかける場合に比べて、より短い時間でこのキーへのブルート フォース攻撃を完了できます。

有効にしても、強制はしない場合、どちらの種類のスマート カード ログオンでも、有効なセキュリティ保護は追加されません。スマート カード ログオンを使用するかどうかは、ユーザーの選択に委ねられるためです。

DPAPI の詳細と、スマート カード ログオンが DPAPI キーに及ぼす影響については、MSDN の記事「[Windows Data Protection](http://technet.microsoft.com/ja-jp/library/ms995355.aspx)」(英語) を参照してください。

![](images/Cc162818.note(ja-jp,TechNet.10).gif)**注 :**

このリスクの説明では、スマート カードと強度の高い PIN を併用し、PIN を推測できないようにスマート カードが PIN ロックアウトを実装すると仮定しています。

次の図は、スマート カード ログオン オプションを使用する Windows XP の EFS 暗号化プロセスを示しています。

![](images/Cc162818.9106cca5-90c1-49dc-87f0-ec6605d165c9(ja-jp,TechNet.10).gif)

**図 3.5 スマート カード ログオンを使用する Windows XP の EFS 暗号化プロセス**

図示した暗号化プロセスの各ステップは、次のとおりです。

1.  ユーザーが暗号化フォルダで新規ファイルを作成します。

2.  対称 FEK がランダムに生成されます。

3.  オペレーティング システムにより、ユーザーの証明書ストアで、適切なキー利用フラグが設定された証明書がないかチェックされます。 適切な証明書がない場合は、証明書が自動的に生成されます。

4.  DPAPI を使用して、ユーザーの証明書に関連付けられた秘密キーが暗号化され、保存されます。 スマート カード ログオンが要求される場合、使用されるパスワードがより強力であるため、この暗号化は前のオプションよりもはるかに強力になります。

5.  証明書の公開キーを使用して FEK が暗号化され、ファイル メタデータに格納されます。

6.  FEK を使用して、データの各ブロックが暗号化されます。

7.  暗号化されたブロックがディスクに書き込まれます。

次の図は、スマート カード ログオン オプションを使用する Windows XP の EFS 暗号化解除プロセスを示しています。

![](images/Cc162818.98911cc3-45af-44be-aa3b-ffa37b9e520d(ja-jp,TechNet.10).gif)

**図 3.6 スマート カード ログオンを使用する Windows XP の EFS 暗号化解除プロセス**

図示した暗号化解除プロセスの各ステップは、次のようになります。

1.  ユーザーのスマート カード ログオンが、ローカルで検証されるか、ドメイン コントローラによって検証されます。

2.  ユーザーが暗号化されたファイルへのアクセスを試行します。

3.  正しい秘密キーが、ユーザーの DPAPI ストアから抽出され、DPAPI が強力なランダム ユーザー パスワードから生成されたキーを使用してこの秘密キーの暗号化を解除します。強力なランダム ユーザー パスワードは、アカウントで **\[ネットワークに接続するにはスマート カードが必要です\]**

4.  FEK がファイルから抽出され、前のステップで抽出した秘密キーで暗号化が解除されます。

5.  アプリケーションがファイルの各ブロックを読み取る場合、FEK を使用してブロックの暗号化が解除され、処理を要求したアプリケーションにデータが渡されます。

#### Windows Vista と、スマート カードを使用する EFS

Windows Vista には強力な新機能が備わっており、スマート カード テクノロジとの大幅な統合を通じて EFS のセキュリティと利便性が強化されています。 Windows XP の場合、スマート カード ログオンは、DPAPI キーの特性を改善する方法を通じて間接的に利用されます。 一方、Windows Vista の場合、EFS でファイルを暗号化するために、スマート カードを直接的に利用できます。 この新機能を使用するにあたり、ユーザーがスマート カードでログオンする必要はありません。また、これによって機能が制限されることもありません。 ただし、スマート カードを要求するように EFS が構成されている場合、ユーザーはスマート カードを挿入して、PIN を入力するように指示されます。

EFS とスマート カードを併用する目的は、公開キーを使用して FEK を直接的に暗号化し、スマート カード上の証明書と対応している秘密キーを使用して FEK の暗号化を解除することです。 このオプションは非常に直接的で安全ですが、アクセスするファイルの暗号化を毎回解除する場合はパフォーマンスが低下します。毎回秘密キーの暗号化を解除するということは、暗号化解除のたびにスマート カードと通信することになり、またスマート カードの CPU がホスト コンピュータの CPU と比べて非常に遅いためです。

この実装のもう 1 つの問題は、いつでもスマート カードの存在が求められることです。ファイルの暗号化を解除しようとする場合、FEK の暗号化を正常に解除するために秘密キーが常に要求されるためです。 スマート カードを使用する EFS オプションのパフォーマンスと利便性を両方とも改善する方法として、スマート カード上の秘密キーから対称キーを生成し、このキーを使用して、暗号化ファイルと関連付けられている FEK の暗号化解除と暗号化を行うように EFS は既定で構成されています。 既定の構成では、生成された対称キーはオペレーティング システムによってキャッシュされるため、それ以降のファイルの暗号化または暗号化解除では、スマート カードや、その関連する秘密キーまたは公開キーが必要ありません。

このオプションがオフである場合、対称キーの生成もキャッシュも実行されず、スマート カード キーを直接的に使用して FEK の暗号化と暗号化の解除が実行されます。 このガイドでは、固有のセキュリティ特性を持つこれら 2 つの異なる操作モードを表すために、キャッシュ キー モードと非キャッシュ キー モード対称キーが生成され、キャッシュされるかどうかを設定する機能については、図 3.2 に示されています\[キャッシュ可能なユーザー キーをスマート カードから作成する\] オプションで示されています。 このオプションがオフである場合、対称キーの生成もキャッシュも実行されず、スマート カード キーを直接的に使用して FEK の暗号化と暗号化の解除が実行されます。

このガイドでは、独自のセキュリティの機能を持つ異なった操作モードを説明するために、「*キャッシュ キー モード*」および「*キャッシュされないキー モード*」という言葉を使用しています。

##### キャッシュ キー モード

キャッシュ キー モードの場合、生成された対称キーは、キャッシュ タイムアウトの期限 (構成可能) が切れるまで、保護された LSA メモリ内にオペレーティング システムによってキャッシュされます。 既定のキャッシュ タイムアウトは、8 時間のシステム アイドル時間です。 生成されたキーで操作が実行されると、フラッシュ タイムアウト期間がリセットされます。 また EFS キー キャッシュのフラッシュは、ユーザーがコンピュータをロックしたとき、またはユーザーがスマート カードを取り外したときに実行されるように構成できます。 キャッシュ キー モードでは、パフォーマンスが大幅に向上し、管理者はスマート カードがカード リーダーに入っていないときでも暗号化ファイルの暗号化と暗号化の解除が実行できるように EFS を構成できます。

![](images/Cc162818.note(ja-jp,TechNet.10).gif)**注 :**

Windows Vista でキャッシュ モードを実装する方法の詳細については、「[Windows Vista セキュリティ ガイド](http://technet.microsoft.com/ja-jp/windows/bb629420.aspx)」をご覧ください。

次の図は、キャッシュ キー モードでの EFS 暗号化プロセスを示しています。

![](images/Cc162818.5cf0f6c0-5a9c-4c49-80da-5690297f89bc(ja-jp,TechNet.10).gif)

**図 3.7 スマート カードを使用する Windows Vista の EFS 暗号化プロセス - キャッシュ キー モード**

図示した暗号化プロセスの各ステップは、次のとおりです。

1.  ユーザーが暗号化フォルダで新規ファイルを作成します。

2.  次の条件のいずれかが満たされると、ユーザーはスマート カードを挿入して PIN を入力するように指示されます。

    -   ユーザーがスマート カードを使用してコンピュータにログオンしなかった。

    -   最近、ユーザーが、EFS ファイルにアクセスするのにスマート カードを使用していなかった。

    -   カードの PIN が最近の EFS 操作でキャッシュされていない。またはアイドル状態であるために PIN キャッシュがクリアされた。

3.  FEK がランダムに生成されます。

4.  次の条件のどちらかが満たされると、対称キーがスマート カードの秘密キーから生成されます。

    -   最初のファイルが暗号化された。

    -   生成されたキーがキャッシュに存在しない。

5.  生成された対象キーを使用して FEK が暗号化され、ファイル メタデータに格納されます。

6.  生成された対称キーは LSA 保護メモリにキャッシュされます。

7.  FEK を使用して、データの各ブロックが暗号化されます。

8.  暗号化されたブロックがディスクに書き込まれます。

次の図は、キャッシュ キー モードでの EFS 暗号化解除プロセスを示しています。

![](images/Cc162818.9239422a-18b2-4d59-a9d4-3d6f7a0ffa8d(ja-jp,TechNet.10).gif)

**図 3.8 スマート カードを使用する Windows Vista の EFS 暗号化解除プロセス - キャッシュ キー モード**

図示した暗号化解除プロセスの各ステップは、次のようになります。

1.  ユーザーが暗号化されたファイルへのアクセスを試行します。

2.  次の条件のいずれかが満たされると、ユーザーはスマート カードを挿入して PIN を入力するように指示されます。

    -   ユーザーがスマート カードを使用してコンピュータにログオンしなかった。

    -   最近、ユーザーが、EFS ファイルにアクセスするのにスマート カードを使用していなかった。

    -   カードの PIN が最近の EFS 操作でキャッシュされていない。またはアイドル状態であるために PIN キャッシュがクリアされた。

3.  キャッシュされていない場合、対称キーはスマート カード ベースの秘密キーから生成されます。 最初に使用した後、生成されたキーは LSA 保護メモリにキャッシュされます。

4.  FEK がファイルから抽出され、生成された対称キーを使用して暗号化が解除されます。

5.  アプリケーションがファイルの各ブロックを読み取る場合、FEK を使用してブロックの暗号化が解除され、処理を要求したアプリケーションにデータが渡されます。

##### 非キャッシュ キー モード

次の図は、非キャッシュ キー モードで EFS を使用する Windows Vista の暗号化プロセスを示しています。

![](images/Cc162818.a1c07b9d-de1a-407a-8ce3-6177d8b91e27(ja-jp,TechNet.10).gif)

**図 3.9 スマート カードを使用する Windows Vista の EFS 暗号化プロセス - 非キャッシュ キー モード**

図示した暗号化プロセスの各ステップは、次のとおりです。

1.  ユーザーが暗号化フォルダで新規ファイルを作成します。

2.  ユーザーのスマート カードがない場合、ユーザーはスマート カードを挿入するように指示されます。

3.  対称 FEK がランダムに生成されます。

4.  証明書の公開キーを使用して FEK が暗号化され、ファイル メタデータに格納されます。

5.  アプリケーションが各データ ブロックを書き込むと、FEK でブロックが暗号化されます。

6.  暗号化されたブロックがディスクに書き込まれます。

次の図は、非キャッシュ キー モードでの EFS 暗号化解除プロセスを示しています。

![](images/Cc162818.b6906b39-323a-463c-aecc-2252dc8be65e(ja-jp,TechNet.10).gif)

**図 3.10 スマート カードを使用する Windows Vista の EFS 暗号化解除プロセス - 非キャッシュ キー モード**

図示した暗号化解除プロセスの各ステップは、次のようになります。

1.  ユーザーが暗号化されたファイルへのアクセスを試行します。

2.  ユーザーのスマート カードがない場合、ユーザーはスマート カードを挿入するように指示されます。 次の条件のいずれかが満たされると、ユーザーは PIN を入力するように指示されます。

    -   ユーザーがスマート カードを使用してコンピュータにログオンしなかった。

    -   最近、ユーザーが、EFS ファイルにアクセスするのにスマート カードを使用していなかった。

    -   カードの PIN が最近の EFS 操作でキャッシュされていない。またはアイドル状態であるために PIN キャッシュがクリアされた。

3.  ファイル用の EFS メタデータがそのファイルから抽出され、暗号化された FEK がスマート カードに渡されます。

4.  スマート カードによってメタデータの暗号化が解除されて FEK が取得され、この FEK がオペレーティング システムに返されます。

5.  アプリケーションがファイルの各ブロックを読み取る場合、FEK を使用してブロックの暗号化が解除され、処理を要求したアプリケーションにデータが渡されます。

#### 軽減されるリスク : スマート カードを使用する EFS

スマート カードを使用する EFS オプションでは、データに対する次のリスクが軽減されます。

-   **休止状態のコンピュータ (Windows Vista の非キャッシュ キー モードのみ)**。 Windows Vista では、EFS で保護されたファイルにアクセスするたびに、スマート カード認証を要求できます。 この操作モードでは、既定のキャッシュ キー スマート カード モードとは異なり、リスクが有効に軽減されます。

-   **スリープ (スタンバイ) モードのコンピュータ (Windows Vista の非キャッシュ キー モードのみ)**。 前述のリスク軽減の説明 (休止状態モード) と同じです。

-   **ログオンしたままのコンピュータ、ロックされていないデスクトップ (Windows Vista の非キャッシュ キー モードのみ)**。 Windows Vista では、EFS で保護されたファイルにアクセスするたびに、スマート カード認証を要求できます。 非キャッシュ キー モードとして知られているこの機能については、この章の前半で説明しましたが、EFS ファイル アクセスのたびにスマート カードを要求することで、効果的にリスクが軽減されます。 このシナリオの場合、利便性に深刻な問題が生じる可能性がありますが、機密データや重要なデータのために最も安全な暗号化ソリューションを必要としている組織にとっては有効なオプションです。

-   **ローカル/ドメイン パスワードの検知**。 第 1 章の「データ セキュリティ上のリスク」で説明したように、狡猾な攻撃者は常に最も脆弱なポイントを利用しようとします。 残念なことですが、多くの場合、IT システムのセキュリティ責任者にとって最も脆弱なポイントとは、非常に強度の低いパスワードを選択するユーザーだったり、非常に強度の高いパスワードをメモに書き留めてモニタに貼り付けているユーザーだったりします。 ネットワーク セキュリティのためにスマート カードベースの 2 要素の認証を実装したら、「対話型ログオンにはスマート カードが必要」といったポリシーを使用して EFS のセキュリティを高めることができます。 Windows Vista では、**\[EFS に対してスマート カードを要求する\]** 設定を有効にしてスマート カード ログオンを強制できない状況でも、機密データにアクセスする際には 2 要素の認証を要求できます。

-   **部内者による暗号化ファイルの閲覧**。 スマート カードを使用する EFS オプションでは、特別な認証要素を追加することでリスクが効果的に軽減されます。

-   **オフライン攻撃によるキーの検出**。 攻撃者がユーザーのパスワードではなく、FEK または DPAPI マスタ キーなどのキーを標的にすると仮定した場合、EFS 回復キー (EFS が使用する証明書の秘密キー) または DPAPI マスタ キーがブルート フォース攻撃にさらされる危険があります。 多くの組織にとって、この脅威は大きな懸念事項にはなりません。EFS が使用する強力なキーに対して、この種類の攻撃が成功することは困難であるためです。

-   **システム ページング ファイルからのプレーンテキスト データの漏洩 (Windows Vista** **のみ)**。 Windows Vista は、システム ページング ファイルを暗号化してこのリスクを効果的に軽減するように構成できます。

-   **プラットフォームへの攻撃 (Windows Vista の非キャッシュ キー モードのみ)**。 キャッシュ キー モードの場合、スマート カード キー ストレージと EFS を併用するように構成されたコンピュータでは、EFS キーがメモリに保持されます。したがって、プラットフォームへの攻撃では、キーが回復される可能性があります。 スマート カード キーをキャッシュに格納しない EFS の場合、キー マテリアルを回復するには、スマート カードに対して直接的な攻撃が必要になるため、この攻撃のリスクは軽減されます。

-   **コンピュータに残された認証要素**。 このオプションの場合、ユーザーは PIN と共に物理的な認証要素を提供する必要があります。この方法により、本格的な複数要素のリスク軽減が実現されます。

#### その他のリスクとその軽減 : スマート カードを使用する EFS

次のリスクは、コントロールやポリシーを追加しないと、スマート カードを使用する EFS オプションでは軽減できません。

-   **休止状態のコンピュータ (Windows XP と Windows Vista のキャッシュ キー モードのみ)**。 スリープまたは休止状態モードからの再開時にパスワード入力を要求するようにコンピュータが構成されていない場合、オペレーティング システムでは、現在のユーザーが適切なユーザーかどうかを判別することができません。 このような状況では、攻撃者が認証されたユーザーになりすましてラップトップを利用できます。 この攻撃者により、重要なデータがリムーバブル デバイスまたはネットワークの特定の場所にコピーされてしまう危険があります。 ただし、スリープまたは休止状態モードからの再開時にユーザーの資格情報を要求するようにコンピュータが構成されている場合、このリスクは軽減されます。 スマート カードを使用する EFS オプションでは、Windows Vista に関連して先に説明したように、このリスクを軽減することができます。

-   **スリープ (スタンバイ) モードのコンピュータ (Windows XP と Windows Vista のキャッシュ キー モードのみ)**。 前述のその他のリスクの説明 (休止状態モード) と同じです。

-   **ログオンしたままのコンピュータ、ロックされていないデスクトップ (Windows XP と Windows Vista のキャッシュ キー モードのみ)**。 ユーザーがコンピュータにログオンした後、資格情報は EFS 用に使用する証明書の暗号化を解除するために利用できます。 暗号化を解除した後は、キーボードを使用できるすべてのユーザーが、暗号化が解除されたデータにアクセスできます。 このリスクを軽減する最も優れた方法は、コンピュータ上に機密情報を持っているユーザーを対象としたセキュリティ意識向上トレーニングです。 スマート カードを使用する EFS オプションでは、Windows Vista に関連して先に説明したように、このリスクを軽減することができます。

-   **オペレーティング システムへのオフライン攻撃**。 EFS には、オフライン攻撃に対して、コンピュータ上のオペレーティング システムを保護する機能や、オペレーティング システム構成ファイルを保護する機能がありません。

-   **オペレーティング システムに対するオンライン攻撃 (Windows XP と Windows Vista のキャッシュ キー モードのみ)**。 オペレーティング システムに対するオンライン攻撃のリスクは、このオプションでは*軽減されません*。 ただし、非キャッシュ キー モードでスマート カードを使用する Windows Vista の場合、攻撃者が EFS キーを回復できないようにすることで、このリスクが部分的に軽減されます。これは、攻撃者がホスト オペレーティング システムで実行中のプログラムにアクセスできないためです。

-   **休止状態ファイルからのプレーンテキスト データの漏えい**。 EFS には、システムの休止状態ファイルを保護する機能がありません。 このリスクは、Windows Vista にアップグレードして BitLocker を使用するか、休止状態を無効にすることで軽減できます。

    ![](images/Cc162818.important(ja-jp,TechNet.10).gif)**重要 :**

    休止状態を無効にすると、モバイル PC の利便性が低下します。 極めて重要な情報資産を保存するコンピュータでは、この方法が適している場合もありますが、通常はもっとふさわしい方法が別にあります。

-   **システム ページング ファイルからのプレーンテキスト データの漏えい (Windows XP** **のみ)**。 Windows XP の場合、システム ページング ファイルなどのシステム ファイルを EFS を使用して暗号化することができません。 この制限は、機密データがアプリケーションからアクセスされる場合、メモリ ページング操作の通常の動作として、データがディスクに書き込まれる可能性があることを意味します。 このリスクは、Windows Vista にアップグレードするか、メモリ ページングを使用しないようにコンピュータを構成することで軽減できます。

    ![](images/Cc162818.important(ja-jp,TechNet.10).gif)**重要 :**

    メモリ ページングを無効にすると、通常、コンピュータのパフォーマンスに影響が出ますが、場合によっては大幅に低下することもあります。

-   **プラットフォームへの攻撃 (Windows XP と Windows Vista のキャッシュ キー モードのみ)**。 キャッシュ キー モードの場合、コンピュータでは、EFS キーがメモリに保持されるため、プラットフォームへの攻撃によってこれらが回復される可能性があります。

-   **ユーザー エラー**。 ユーザーは EFS が有効になっていない場所に、機密データを含むファイルを保存しないように注意する必要があります。 Windows Vista の場合、ユーザーのドキュメント フォルダにあるファイルをすべて暗号化できる EFS 構成オプションがあるため、このリスクは部分的に軽減されています。 この機能により、適切なファイルとディレクトリの暗号化を確実に行うことが容易になります。 また EFS アシスタント ツール (このソリューション アクセラレータの一部として提供されます) を使用して、EFS によるユーザー ファイル保護のプロセスを自動化することで、このリスクを軽減することもできます。

[](#mainsection)[ページのトップへ](#mainsection)

### EFS リスク分析の要約

次の表は、各データ リスクの軽減について、どの EFS オプションが有効かを示しています。 Windows XP ベースのコンピュータでは、\[ネットワークに接続するにはスマート カードが必要です\] ドメイン ユーザー設定を有効にします。 Windows Vista ベースのコンピュータでは、コンピュータ上で \[EFS に対してスマート カードを要求する\] と Windows Vista ベースのコンピュータでは、コンピュータの EFS 設定の、\[EFS 用のスマート カードが必要\] および \[ページファイルの暗号化を有効にする\] が有効にされています。リスクが特定のオプションで軽減され場合は「Y」の文字で示され、リスクが特定のオプションであまり軽減されない、または軽減されない場合はハイフォン「-」で示されます。

**表 3.1 EFS のリスク軽減**

![](images/Cc162818.0d76df62-1c23-49d8-beb0-9bd64db9f966(ja-jp,TechNet.10).gif)
[](#mainsection)[ページのトップへ](#mainsection)

### 関連情報

-   [Encrypting File System Technical Reference (英語)](http://technet.microsoft.com/ja-jp/library/cc780166.aspx)

-   [Windows Data Protection (英語)](http://technet.microsoft.com/ja-jp/library/ms995355.aspx)

-   [Windows Vista セキュリティ ガイド](http://technet.microsoft.com/ja-jp/windows/bb629420.aspx)

[](#mainsection)[ページのトップへ](#mainsection)

##### 目次

-   [概要](https://technet.microsoft.com/ja-jp/library/abfc4696-a39a-43df-b559-133633e4bd5e(v=TechNet.10))
-   [第 1 章 : リスクの検討](https://technet.microsoft.com/ja-jp/library/df2c6d71-98f7-4212-b3b7-b9eb2f501348(v=TechNet.10))
-   [第 2 章 : BitLocker ドライブ暗号化](https://technet.microsoft.com/ja-jp/library/4e6ce820-fcac-495a-9f23-73d65d846638(v=TechNet.10))
-   第 3 章 : 暗号化ファイル システム
-   [第 4 章 : BitLocker と EFS の併用](https://technet.microsoft.com/ja-jp/library/80c0d0af-2c2e-45d6-9b29-f850926296bb(v=TechNet.10))
-   [第 5 章 : 適切なソリューションを選択する](https://technet.microsoft.com/ja-jp/library/b77d6369-10e9-4e66-8c67-c9f8cb073ced(v=TechNet.10))

[](#mainsection)[ページのトップへ](#mainsection)
